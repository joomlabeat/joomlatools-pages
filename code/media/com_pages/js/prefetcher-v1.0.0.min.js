/**
 * Joomlatools Pages
 *
 * @copyright   Copyright (C) 2018 Johan Janssens and Timble CVBA. (http://www.timble.net)
 * @license     GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
 * @link        https://github.com/joomlatools/joomlatools-pages for the canonical source repository
 */

// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&dn=gpl-3.0.txt Expat
class Prefetcher{constructor(e){this.cache=new Set,this.hoverTimer,this.hoverTimestamp,(e=e||{}).onload=e.onload||!1,e.onhover=e.onhover||!0,e.onclick=e.onclick||!1,e.limit=e.limit||1/0,e.throttle=e.throttle||1/0,e.delay=e.delay||100,e.timeout=e.timeout||1e3,e.savedata=e.savedata||!0,e.elements=e.elements||"a",e.origins=e.origins||[location.hostname],e.ignored=e.ignored||[e=>e.includes("#")],e.debug=e.debug||!1,this.options=e,this.log("Prefetcher Options",this.options),this.options.onload&&document.addEventListener("DOMContentLoaded",()=>this.onLoad()),this.options.onhover&&this.onHover(),this.options.onclick&&this.onClick()}onClick(){document.addEventListener("mousedown",function(e){if(!(this.hoverTimestamp>performance.now()-500)){var t=e.target;this.isPrefetchable(t)&&this.prerender(t.href,"click")}}.bind(this),{capture:!0,passive:!0})}onHover(){document.addEventListener("touchstart",function(e){var t=e.target;this.isPrefetchable(t)&&(this.hoverTimestamp=performance.now(),this.prerender(t.href,"touch"))}.bind(this),{capture:!0,passive:!0}),document.addEventListener("mouseover",function(e){if(!(this.hoverTimestamp>performance.now()-500)){var t=e.target;this.isPrefetchable(t)&&(this.hoverTimer=setTimeout(()=>{this.prerender(t.href,"hover"),this.hoverTimer=!1},this.options.delay),t.addEventListener("mouseout",function(e){this.hoverTimer&&(clearTimeout(this.hoverTimer),this.hoverTimer=void 0)}.bind(this),{capture:!0,passive:!0}))}}.bind(this),{capture:!0,passive:!0})}onLoad(){if(!window.IntersectionObserver)return;const e=navigator.connection;if(e&&this.options.savedata&&(e.effectiveType.includes("2g")||e.saveData))return;const[t,o]=this.throttle(this.options.throttle);var i=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(i.unobserve(e=e.target),this.cache.size<this.options.limit&&t(()=>{this.prefetch(e.href,"load").then(o).catch(e=>{o()})}))})});return window.requestIdleCallback(()=>{document.querySelectorAll(this.options.elements).forEach(e=>{e instanceof HTMLAnchorElement?this.isPrefetchable(e)&&i.observe(e):e.querySelectorAll("a").forEach(e=>{this.isPrefetchable(e)&&i.observe(e)})})},{timeout:this.options.timeout}),function(){i.disconnect()}}prerender(e,t){var o;e=new URL(e,location.href).toString();return this.cache.has(e)||(this.cache.add(e),(o=this.isSupported("prerender")?this.prerenderViaDOM(e):fetch(e,{credentials:"include"})).then(o=>this.log("Prerendering on "+t+":",e))),Promise.all([o])}prerenderViaDOM(e){return new Promise((t,o,i)=>{(i=document.createElement("link")).rel="prerender",i.href=e,i.as="document",i.onload=t(),i.onerror=o(),document.head.appendChild(i)})}prefetch(e,t){var o;e=new URL(e,location.href).toString();return this.cache.has(e)||(this.cache.add(e),(o=this.isSupported("prefetch")?this.prefetchViaDOM(e):this.prefetchViaXHR(e)).then(o=>this.log("Prefetched on "+t+":",e))),Promise.all([o])}prefetchViaDOM(e){return new Promise((t,o,i)=>{(i=document.createElement("link")).rel="prefetch",i.href=e,i.as="document",i.onload=t(),i.onerror=o(),document.head.appendChild(i)})}prefetchViaXHR(e){return new Promise((t,o,i)=>{(i=new XMLHttpRequest).open("GET",e,i.withCredentials=!0,!0),i.onload=(()=>{200===i.status?t():o()}),i.send()})}isPrefetchable(e){return!(!e||!e.href)&&(!e.download&&(!(this.options.origins.length&&!this.options.origins.includes(new URL(e.href,location.href).hostname))&&(!!["http:","https:"].includes(e.protocol)&&!this.isIgnored(e,this.options.ignored))))}isIgnored(e,t){return Array.isArray(t)?t.some(t=>this.isIgnored(e,t)):(t.test||t).call(t,e.href,e)}isSupported(e){var t=document.createElement("link");return t.relList&&t.relList.supports&&t.relList.supports(e)}log(){this.options.debug&&console&&("function"==typeof console.log?console.log.apply(console,arguments):console.log&&console.log(arguments))}throttle(e){e=e||1;var t=[],o=0;function i(){o<e&&t.length>0&&(t.shift()(),o++)}return[function(e){t.push(e)>1||i()},function(){o--,i()}]}}window.requestIdleCallback=window.requestIdleCallback||function(e){var t=Date.now();return setTimeout(function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)};
// @license-end